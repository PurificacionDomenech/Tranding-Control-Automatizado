# Prompt para Resolver Problemas de TradingControl

Hola, necesito ayuda para resolver 4 problemas cr√≠ticos en mi aplicaci√≥n **TradingControl**. He entrado en un bucle de debugging y necesito un enfoque met√≥dico.

## CONTEXTO COMPLETO

Tengo dos aplicaciones:

1. **TradingControl** (la problem√°tica) - Aplicaci√≥n de trading con backend Python/Flask + Supabase
2. **Monarca Band** (de referencia) - Presentaci√≥n que funciona perfectamente, solo frontend

**Te he adjuntado:**
- ‚úÖ `index.html` ‚Üí TradingControl (CON PROBLEMAS - Backend + DB)
- ‚úÖ `MB.html` ‚Üí Monarca Band (FUNCIONA BIEN - Solo frontend de referencia)

---

## LO QUE NECESITO QUE HAGAS

### PASO 1: Analizar el C√≥digo de Referencia (Monarca Band)

**Examina el archivo `MB.html` (Monarca Band)** y f√≠jate en estos patrones que **S√ç funcionan correctamente**:

1. **C√≥mo se cierra el lightbox despu√©s de usarlo:**
   ```javascript
   function openLightbox(src, title) {
     document.getElementById('lightbox').style.display = 'flex';
   }
   
   function closeLightbox() {
     document.getElementById('lightbox').style.display = 'none';
   }
   ```
   ‚òùÔ∏è **FUNCIONA**: Se cierra limpiamente sin problemas

2. **C√≥mo se actualizan los dots/indicadores sin duplicar:**
   ```javascript
   function updateDots() {
     dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
   }
   ```
   ‚òùÔ∏è **FUNCIONA**: No duplica elementos, solo actualiza clases

3. **C√≥mo se manejan eventos de teclado:**
   ```javascript
   document.addEventListener('keydown', e => {
     if (e.key === 'ArrowLeft') moveSlide(-1);
     if (e.key === 'ArrowRight') moveSlide(1);
   });
   ```
   ‚òùÔ∏è **FUNCIONA**: Eventos limpios sin memory leaks

---

### PASO 2: Identificar Qu√© Est√° Mal en TradingControl

Ahora examina el archivo `index.html` (TradingControl) y comp√°ralo con los patrones funcionales de MB.html (Monarca Band).

---

## LOS 4 PROBLEMAS A RESOLVER

### üî¥ PROBLEMA 1: Duplicados en Base de Datos (Cr√≠tico)

**Ubicaci√≥n:** `main.py` (backend) - Endpoint `/api/importar-csv`

**S√≠ntoma:**
- Cada vez que importo el mismo CSV, se insertan registros duplicados en Supabase
- La base de datos crece infinitamente con datos repetidos

**Lo que necesito:**
```python
# ANTES de insertar en la DB, verificar si existe:
# Clave √∫nica: cuenta_id + fecha_operacion + hora_entrada + instrumento
# 
# Si existe ‚Üí IGNORAR
# Si NO existe ‚Üí INSERTAR
```

**Pregunta espec√≠fica:**
> ¬øPuedes mostrarme c√≥mo modificar el endpoint `/api/importar-csv` en `main.py` para que verifique duplicados usando la clave √∫nica (cuenta_id + fecha_operacion + hora_entrada + instrumento) antes de insertar?

---

### üü° PROBLEMA 2: Modal No Se Cierra Despu√©s de Importar

**Ubicaci√≥n:** `index.html` (TradingControl) - Funci√≥n `confirmImport()`

**S√≠ntoma:**
- Importo CSV correctamente
- La importaci√≥n es exitosa
- Pero el modal se queda abierto y debo cerrarlo manualmente

**Comparaci√≥n con c√≥digo funcional (MB.html):**
- En MB.html (Monarca Band), `closeLightbox()` funciona perfectamente
- En index.html (TradingControl), `closeImportModal()` NO se ejecuta despu√©s del √©xito

**Pregunta espec√≠fica:**
> Compara la funci√≥n `closeLightbox()` de MB.html con `closeImportModal()` de index.html. ¬øPor qu√© una funciona y la otra no? ¬øD√≥nde debo llamar a `closeImportModal()` exactamente en la funci√≥n `confirmImport()`?

---

### üü° PROBLEMA 3: Gr√°fico de Crecimiento No Se Renderiza

**Ubicaci√≥n:** `index.html` (TradingControl) - Funci√≥n `renderCapitalGrowthChart()`

**S√≠ntoma:**
- El gr√°fico funcionaba antes de conectar Supabase
- Ahora no aparece nada
- Probable causa: formato de datos incorrecto desde la API

**Probable error:**
```javascript
// Los datos de Supabase vienen as√≠:
{ amount: "150.50", date: "2025-01-15" }  // ‚ùå amount es STRING

// Pero Chart.js espera esto:
{ amount: 150.50, date: Date object }     // ‚úÖ amount es NUMBER
```

**Pregunta espec√≠fica:**
> Examina la funci√≥n `renderCapitalGrowthChart()` en index.html (TradingControl). Los datos vienen de Supabase a trav√©s de `mapAPIOperationToFrontend()`. ¬øQu√© transformaciones (parseFloat, new Date, etc.) necesito aplicar antes de pasarlos a Chart.js?

---

### üü¢ PROBLEMA 4: Resetear Datos Solo Borra localStorage

**Ubicaci√≥n:** `index.html` (TradingControl) - Funci√≥n `resetAllData()` + nuevo endpoint en `main.py`

**S√≠ntoma:**
- Hago clic en "Resetear Datos"
- Se borra en localStorage (JavaScript)
- Pero los datos siguen en Supabase
- Al recargar la p√°gina, todo vuelve a aparecer

**Lo que necesito:**
1. **Backend:** Crear endpoint `DELETE /api/operaciones` que borre de la DB
2. **Frontend:** Modificar `resetAllData()` para que llame a ese endpoint

**Pregunta espec√≠fica:**
> ¬øPuedes mostrarme:
> 1. C√≥mo crear el endpoint `DELETE /api/operaciones` en `main.py`
> 2. C√≥mo modificar la funci√≥n `resetAllData()` en index.html para que primero borre en Supabase y luego en localStorage?

---

## METODOLOG√çA DE TRABAJO

**Por favor, trabaja EN ORDEN:**

1. ‚úÖ Primero analiza MB.html (Monarca Band) para entender los patrones correctos
2. ‚úÖ Luego compara con index.html (TradingControl) para identificar las diferencias
3. ‚úÖ Resuelve los problemas UNO POR UNO (no todos a la vez)
4. ‚úÖ Espera mi confirmaci√≥n de que funciona antes de pasar al siguiente

**Empecemos por el Problema 1** (duplicados en DB), que es el m√°s cr√≠tico.

---

## INFORMACI√ìN ADICIONAL

- **Supabase URL:** `https://bjjjutlfinxdwmifskdw.supabase.co`
- **Backend API:** Python/Flask corriendo en Replit
- **Frontend:** HTML/JS puro (no frameworks)
- **Chart.js:** Ya est√° importado y funciona (solo necesita datos correctos)

---

## ARCHIVOS QUE HE ADJUNTADO

1. **`index.html`** ‚Üí TradingControl (la aplicaci√≥n con problemas)
2. **`MB.html`** ‚Üí Monarca Band (aplicaci√≥n de referencia que funciona bien)

---

¬øEst√°s listo para empezar? Analiza primero los patrones de MB.html y luego dime qu√© ves mal en index.html para el **Problema 1 (duplicados)**.